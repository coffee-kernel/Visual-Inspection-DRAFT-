# ---- STEP 1 ---- #
sudo apt update
sudo apt install -y build-essential cmake git pkg-config \
    libgtk-3-dev libavcodec-dev libavformat-dev libswscale-dev \
    libv4l-dev libxvidcore-dev libx264-dev libjpeg-dev libpng-dev libtiff-dev \
    gfortran openjdk-11-jdk python3-dev python3-numpy python3-pip \
    libtbb2 libtbb-dev libdc1394-dev libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev libprotobuf-dev protobuf-compiler

# ---- STEP 2 ---- #
mkdir -p ~/opencv_build && cd ~/opencv_build
git clone --branch 4.10.0 --depth 1 https://github.com/opencv/opencv.git
git clone --branch 4.10.0 --depth 1 https://github.com/opencv/opencv_contrib.git

# ---- STEP 3 ---- #
cd ~/opencv_build/opencv
mkdir -p build && cd build

PYTHON_BIN=/usr/bin/python3
PYTHON_INCLUDE_DIR=$($PYTHON_BIN -c "from sysconfig import get_paths as gp; print(gp()['include'])")
PYTHON_PACKAGES_PATH=$($PYTHON_BIN -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())")

cmake -D CMAKE_BUILD_TYPE=RELEASE \
      -D CMAKE_INSTALL_PREFIX=/usr/local \
      -D OPENCV_EXTRA_MODULES_PATH=~/opencv_build/opencv_contrib/modules \
      -D OPENCV_GENERATE_PKGCONFIG=ON \
      -D WITH_CUDA=ON \
      -D CUDA_ARCH_BIN=8.7 \
      -D WITH_CUDNN=ON \
      -D OPENCV_DNN_CUDA=ON \
      -D WITH_CUBLAS=ON \
      -D ENABLE_FAST_MATH=ON \
      -D CUDA_FAST_MATH=ON \
      -D WITH_GSTREAMER=ON \
      -D WITH_LIBV4L=ON \
      -D BUILD_opencv_python3=ON \
      -D PYTHON3_EXECUTABLE=${PYTHON_BIN} \
      -D PYTHON3_INCLUDE_DIR=${PYTHON_INCLUDE_DIR} \
      -D PYTHON3_PACKAGES_PATH=${PYTHON_PACKAGES_PATH} \
      -D BUILD_EXAMPLES=OFF \
      -D BUILD_TESTS=OFF \
      -D BUILD_PERF_TESTS=OFF \
      -D OPENCV_ENABLE_NONFREE=ON ..

# ---- STEP 4 ---- #
make -j$(nproc)
sudo make install
sudo ldconfig



